# Задание 13. Задачи по теме Анализ парных/повторных наблюдений

library(exact2x2)
library(pwr)

# 13.1
больные <- as.data.frame(matrix(c(81,48, 23,21), nrow = 2, byrow = TRUE))
colnames(больные) <- c("d+", "d-")
rownames(больные) <- c("k+", "k-")
mosaicplot(больные, main = "Mosaic plot", color = TRUE)
больные.матрица <- as.matrix(больные)
# Являются ли наблюдаемые различия значимыми?
# Проведем тест МакНемара как с поправкой на непрерывность,
# так и без нее, чтобы просмотреть различия
mcnemar.test(больные.матрица) # критерий Мак-Немара // по умолчанию с поправкой Эдвардса
# p-value = 0.004396
mcnemar.test(больные.матрица, correct = FALSE)
# p-value = 0.003008
mcnemar.exact(больные.матрица) # точный
# p-value = 0.004065
# Во всех случаях p-значение теста меньше 0.05, поэтому мы
# отвергаем нулевую гипотезу и делаем вывод,
# что наблюдаемые различия статистически значимо отличаются.

# 13.2
# Эффективно ли полоскание хлоридом аммония?
teeth <- as.data.frame(matrix(c(32,14,60,39,25,24,45,13,65,9,60,3,68,10,83,14,120,1,110,36), nrow = 10, byrow = TRUE))
colnames(teeth) <- c("Хлорид аммония", "Хлоргексидин")
# Посмотрим на графике
mosaicplot(teeth, main = "Mosaic plot", color = TRUE)
# На графике похоже, что хлоргексидином эффективнее,
# проверим статистически
chisq.test(teeth)$expected
chisq.test(teeth)
# p-value < 2.2e-16
# Отличия статистически значимы.
# Данные позволяют считать полоскание хлоргексидином эффективнее.

# 13.3
# 3.	Проверьте, выполнены ли условия применения
# парного критерия Стьюдента в данных задачи 2.

# Проверка гипотезы это:
#
# H0: нет разницы в среднем
# H1: два средства разные

var(teeth$`Хлоргексидин`)
var(teeth$`Хлорид аммония`)
# Дисперсии разные, поэтому у теста указываем var.equal = FALSE
t.test(teeth$`Хлорид аммония`, teeth$`Хлоргексидин`, var.equal = FALSE)
# p-value = 0.0004302, что меньше значения 0.05.
# Отвергаем нулевую гепотезу и принимаем альтернативную.
# Делаем вывод, что средние показатели двух групп значимо отличаются.
# mean of x mean of y
#      66.8      16.3


# 13.4  4.	Оцените мощность критерия, которая будет достигнута
# на выборках в 1-й и 2-й задачах.

(res <- chisq.test(больные))
(obs <- res$observed)
(exptd <- res$expected)
# 173 - количество участников эксперимента
(obs <- obs/173) # частоты
(exptd <- exptd/173)  # частоты
(sqrt(sum((exptd-obs)^2/exptd)) )# w - размер эффекта
# 0.09354314
ES.w2(obs) # функция для расчёта размера эффекта
# 0.09354314
# -----------------
# Показатель w изменяется от 0 до 1, и чем ближе
# его значение к 1, тем сильнее эффект исследуемого фактора.
# -----------------
pwr.chisq.test(w = ES.w2(obs), df = 2-1, N = 173)
# 173 - количество участников эксперимента
#              w = 0.09354314
#              N = 173
#              df = 1
#              sig.level = 0.05
#              power = 0.2335291
# Рассчитанная мощность (~ 23%) гораздо ниже условно принятого
# порога в 80%. Таким образом, ряд специалистов не
# имеет оснований считать, что воспалительная реакция может
# быть вызвана местнораздражающим действием динитрохлорбензола
# и не отражает состояния иммунитета. Число результатов опыта
# недостаточно для такого вывода при таком
# небольшом размере эффекта.

(res <- chisq.test(teeth))
(obs <- res$observed)
(exptd <- res$expected)
# 10 - количество участников эксперимента
(obs <- obs/10) # частоты
(exptd <- exptd/10)  # частоты
effect <- (sqrt(sum((exptd-obs)^2/exptd)))# w - размер эффекта
effect
# 3.160142
pwr.chisq.test(w = effect, df = (2-1), N = 10)
#               w = 3.160142
#               N = 10
#              df = 1
#       sig.level = 0.05
#           power = 1
# Рассчитанная мощность (1 ~ 100%) гораздо выше условно принятого
# порога в 80%. Таким образом, число результатов опыта
# достаточно для того, чтобы сделать вывод -
# Полоскание с хлоргексидином более эффективно.

